# sbt-smaller-docker

[![Build Status](https://travis-ci.org/GlobalWebIndex/sbt-smaller-docker.svg?branch=master)](https://travis-ci.org/GlobalWebIndex/sbt-smaller-docker)
[ ![Download](https://api.bintray.com/packages/lustefaniak/sbt-plugins/sbt-smaller-docker/images/download.svg) ](https://bintray.com/lustefaniak/sbt-plugins/sbt-smaller-docker/_latestVersion)

Plugin which alters how Dockerfile is generated by sbt-native-packager to reuse existing layers and minimize download/push time.

## Docker image generated by sbt-native-packager
When using default sbt-native-packager Dockerfile we get something like that:

```dockerfile
FROM anapsix/alpine-java:8u144b01_jdk_unlimited
WORKDIR /opt/chronicle-pro-sink
ADD --chown=daemon:daemon opt /opt
EXPOSE 8000 10001
RUN ["mkdir", "-p", "/opt/chronicle-pro-sink/native/"]
RUN ["chown", "-R", "daemon:daemon", "/opt/chronicle-pro-sink/native/"]
VOLUME ["/opt/chronicle-pro-sink/native/"]
USER daemon
ENTRYPOINT ["bin/chronicle-pro-sink"]
CMD []
```

Generated Docker layers are:

```
af6742fcf248 Virtual Size: 173.3 MB Tags: anapsix/alpine-java:8u144b01_jdk_unlimited
└─468cabd1c06c Virtual Size: 173.3 MB
  ├─2124f4239371 Virtual Size: 245.5 MB
  │ └─c57863e9d6ea Virtual Size: 245.5 MB
  │   └─c814c05ce7b8 Virtual Size: 245.5 MB
  │     └─03f77d826d9a Virtual Size: 245.5 MB
  │       └─a4cb2b7ae9e0 Virtual Size: 245.5 MB
  │         └─95f0cc7731a0 Virtual Size: 245.5 MB
  │           └─392eda0a60b6 Virtual Size: 245.5 MB
  │             └─a059fd2083c8 Virtual Size: 245.5 MB Tags: gwidx/chronicle-pro-sink:1.0.3
  └─163f3e4e0b40 Virtual Size: 245.5 MB
    └─23ebf7c0b4f2 Virtual Size: 245.5 MB
      └─444159a52437 Virtual Size: 245.5 MB
        └─fcb230f5ea79 Virtual Size: 245.5 MB
          └─f91a49adfd95 Virtual Size: 245.5 MB
            └─c42611b9b755 Virtual Size: 245.5 MB
              └─f47c75d08af1 Virtual Size: 245.5 MB
                └─0d6c5eb15645 Virtual Size: 245.5 MB Tags: gwidx/chronicle-pro-sink:1.0.2
```

Main problem here is that dependency JARs are added together with application JAR, so whole layer gets much larger and there is no layer sharing between images. Even if change in the application is tiny, we need to push 72MB.

## Docker image generated by sbt-smaller-docker

When plugin is enabled it generates:

```dockerfile
FROM anapsix/alpine-java:8u144b01_jdk_unlimited
WORKDIR /opt/chronicle-pro-sink
EXPOSE 8000 10001
RUN ["mkdir", "-p", "/opt/chronicle-pro-sink/native/"]
RUN ["chown", "-R", "daemon:daemon", "/opt/chronicle-pro-sink/native/"]
VOLUME ["/opt/chronicle-pro-sink/native/"]
RUN mkdir -p /opt /opt/docker /opt/app-name /opt/chronicle-pro-sink /opt/docker/bin /opt/docker/lib /opt/docker/conf /opt/app-name/bin /opt/app-name/lib /opt/app-name/conf /opt/chronicle-pro-sink/bin /opt/chronicle-pro-sink/yourkit /opt/chronicle-pro-sink/lib /opt/chronicle-pro-sink/conf /opt/chronicle-pro-sink/yourkit/linux-x86-64
ADD opt/chronicle-pro-sink/lib/ch.qos.logback.logback-classic-1.2.3.jar opt/chronicle-pro-sink/lib/ch.qos.logback.logback-core-1.2.3.jar opt/chronicle-pro-sink/lib/com.carrotsearch.hppc-0.7.1.jar opt/chronicle-pro-sink/lib/com.fasterxml.jackson.core.jackson-annotations-2.8.8.jar opt/chronicle-pro-sink/lib/com.fasterxml.jackson.core.jackson-core-2.8.9.jar opt/chronicle-pro-sink/lib/com.fasterxml.jackson.core.jackson-databind-2.8.9.jar opt/chronicle-pro-sink/lib/com.fasterxml.jackson.dataformat.jackson-dataformat-cbor-2.8.8.jar opt/chronicle-pro-sink/lib/com.fasterxml.jackson.dataformat.jackson-dataformat-smile-2.8.8.jar opt/chronicle-pro-sink/lib/com.fasterxml.jackson.dataformat.jackson-dataformat-yaml-2.8.6.jar opt/chronicle-pro-sink/lib/com.fasterxml.jackson.module.jackson-module-paranamer-2.8.8.jar opt/chronicle-pro-sink/lib/com.fasterxml.jackson.module.jackson-module-scala_2.12-2.8.8.jar opt/chronicle-pro-sink/lib/com.github.mpilquist.simulacrum_2.12-0.10.0.jar opt/chronicle-pro-sink/lib/com.github.scopt.scopt_2.12-3.5.0.jar opt/chronicle-pro-sink/lib/com.sksamuel.elastic4s.elastic4s-core_2.12-5.4.3.jar opt/chronicle-pro-sink/lib/com.sksamuel.elastic4s.elastic4s-http_2.12-5.4.3.jar opt/chronicle-pro-sink/lib/com.sksamuel.exts.exts_2.12-1.44.0.jar opt/chronicle-pro-sink/lib/com.sksamuel.scapegoat.scalac-scapegoat-plugin_2.12-1.3.1.jar opt/chronicle-pro-sink/lib/com.tdunning.t-digest-3.1.jar opt/chronicle-pro-sink/lib/com.thoughtworks.paranamer.paranamer-2.8.jar opt/chronicle-pro-sink/lib/com.typesafe.akka.akka-actor_2.12-2.5.9.jar opt/chronicle-pro-sink/lib/com.typesafe.akka.akka-http-core_2.12-10.0.11.jar opt/chronicle-pro-sink/lib/com.typesafe.akka.akka-http-spray-json_2.12-10.0.11.jar opt/chronicle-pro-sink/lib/com.typesafe.akka.akka-http_2.12-10.0.11.jar opt/chronicle-pro-sink/lib/com.typesafe.akka.akka-parsing_2.12-10.0.11.jar opt/chronicle-pro-sink/lib/com.typesafe.akka.akka-slf4j_2.12-2.5.9.jar opt/chronicle-pro-sink/lib/com.typesafe.akka.akka-stream-kafka_2.12-0.16.jar opt/chronicle-pro-sink/lib/com.typesafe.akka.akka-stream_2.12-2.5.9.jar opt/chronicle-pro-sink/lib/com.typesafe.config-1.3.2.jar opt/chronicle-pro-sink/lib/com.typesafe.scala-logging.scala-logging_2.12-3.7.1.jar opt/chronicle-pro-sink/lib/com.typesafe.ssl-config-core_2.12-0.2.2.jar opt/chronicle-pro-sink/lib/com.vividsolutions.jts-1.13.jar opt/chronicle-pro-sink/lib/com.wacai.config-annotation_2.12-0.3.7.jar opt/chronicle-pro-sink/lib/commons-codec.commons-codec-1.10.jar opt/chronicle-pro-sink/lib/io.kamon.kamon-akka-2.4_2.12-0.6.6.jar opt/chronicle-pro-sink/lib/io.kamon.kamon-akka-http_2.12-0.6.6.jar opt/chronicle-pro-sink/lib/io.kamon.kamon-autoweave_2.12-0.6.5.jar opt/chronicle-pro-sink/lib/io.kamon.kamon-core_2.12-0.6.6.jar opt/chronicle-pro-sink/lib/io.kamon.kamon-scala_2.12-0.6.6.jar opt/chronicle-pro-sink/lib/io.kamon.kamon-system-metrics_2.12-0.6.6.jar opt/chronicle-pro-sink/lib/io.kamon.sigar-loader-1.6.5-rev002.jar opt/chronicle-pro-sink/lib/io.spray.spray-json_2.12-1.3.4.jar opt/chronicle-pro-sink/lib/joda-time.joda-time-2.9.9.jar opt/chronicle-pro-sink/lib/net.jpountz.lz4.lz4-1.3.0.jar opt/chronicle-pro-sink/lib/net.logstash.logback.logstash-logback-encoder-4.11.jar opt/chronicle-pro-sink/lib/net.sf.jopt-simple.jopt-simple-5.0.2.jar opt/chronicle-pro-sink/lib/org.apache.httpcomponents.httpasyncclient-4.1.2.jar opt/chronicle-pro-sink/lib/org.apache.httpcomponents.httpclient-4.5.3.jar opt/chronicle-pro-sink/lib/org.apache.httpcomponents.httpcore-4.4.6.jar opt/chronicle-pro-sink/lib/org.apache.httpcomponents.httpcore-nio-4.4.5.jar opt/chronicle-pro-sink/lib/org.apache.kafka.kafka-clients-0.10.2.1.jar opt/chronicle-pro-sink/lib/org.apache.logging.log4j.log4j-api-2.8.2.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-analyzers-common-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-backward-codecs-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-core-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-grouping-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-highlighter-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-join-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-memory-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-misc-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-queries-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-queryparser-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-sandbox-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-spatial-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-spatial-extras-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-spatial3d-6.5.0.jar opt/chronicle-pro-sink/lib/org.apache.lucene.lucene-suggest-6.5.0.jar opt/chronicle-pro-sink/lib/org.aspectj.aspectjweaver-1.8.10.jar opt/chronicle-pro-sink/lib/org.elasticsearch.client.rest-5.4.0.jar opt/chronicle-pro-sink/lib/org.elasticsearch.elasticsearch-5.4.0.jar opt/chronicle-pro-sink/lib/org.elasticsearch.jna-4.4.0.jar opt/chronicle-pro-sink/lib/org.elasticsearch.securesm-1.1.jar opt/chronicle-pro-sink/lib/org.hdrhistogram.HdrHistogram-2.1.9.jar opt/chronicle-pro-sink/lib/org.locationtech.spatial4j.spatial4j-0.6.jar opt/chronicle-pro-sink/lib/org.reactivestreams.reactive-streams-1.0.2.jar opt/chronicle-pro-sink/lib/org.scala-lang.modules.scala-java8-compat_2.12-0.8.0.jar opt/chronicle-pro-sink/lib/org.scala-lang.modules.scala-parser-combinators_2.12-1.0.4.jar opt/chronicle-pro-sink/lib/org.scala-lang.modules.scala-xml_2.12-1.0.5.jar opt/chronicle-pro-sink/lib/org.scala-lang.scala-library-2.12.4.jar opt/chronicle-pro-sink/lib/org.scala-lang.scala-reflect-2.12.4.jar opt/chronicle-pro-sink/lib/org.scala-sbt.test-interface-1.0.jar opt/chronicle-pro-sink/lib/org.scalacheck.scalacheck_2.12-1.13.5.jar opt/chronicle-pro-sink/lib/org.slf4j.jcl-over-slf4j-1.7.25.jar opt/chronicle-pro-sink/lib/org.slf4j.slf4j-api-1.7.25.jar opt/chronicle-pro-sink/lib/org.typelevel.catalysts-macros_2.12-0.0.5.jar opt/chronicle-pro-sink/lib/org.typelevel.catalysts-platform_2.12-0.0.5.jar opt/chronicle-pro-sink/lib/org.typelevel.cats-core_2.12-0.9.0.jar opt/chronicle-pro-sink/lib/org.typelevel.cats-free_2.12-0.9.0.jar opt/chronicle-pro-sink/lib/org.typelevel.cats-jvm_2.12-0.9.0.jar opt/chronicle-pro-sink/lib/org.typelevel.cats-kernel-laws_2.12-0.9.0.jar opt/chronicle-pro-sink/lib/org.typelevel.cats-kernel_2.12-0.9.0.jar opt/chronicle-pro-sink/lib/org.typelevel.cats-laws_2.12-0.9.0.jar opt/chronicle-pro-sink/lib/org.typelevel.cats-macros_2.12-0.9.0.jar opt/chronicle-pro-sink/lib/org.typelevel.cats_2.12-0.9.0.jar opt/chronicle-pro-sink/lib/org.typelevel.discipline_2.12-0.7.2.jar opt/chronicle-pro-sink/lib/org.typelevel.machinist_2.12-0.6.1.jar opt/chronicle-pro-sink/lib/org.typelevel.macro-compat_2.12-1.1.1.jar opt/chronicle-pro-sink/lib/org.xerial.snappy.snappy-java-1.1.2.6.jar opt/chronicle-pro-sink/lib/org.yaml.snakeyaml-1.15.jar /opt/chronicle-pro-sink/lib/
ADD opt/chronicle-pro-sink/conf/application.ini /opt/chronicle-pro-sink/conf/
ADD opt/chronicle-pro-sink/bin/chronicle-pro-sink opt/chronicle-pro-sink/bin/chronicle-pro-sink.bat /opt/chronicle-pro-sink/bin/
ADD opt/chronicle-pro-sink/lib/chronicle-pro-sink.chronicle-pro-sink-1.0.2.jar /opt/chronicle-pro-sink/lib/
USER daemon
ENTRYPOINT ["bin/chronicle-pro-sink"]
CMD []

```

And generated layers are:

```
af6742fcf248 Virtual Size: 173.3 MB Tags: anapsix/alpine-java:8u144b01_jdk_unlimited
└─50399c01684f Virtual Size: 173.3 MB
  └─68ae28edf637 Virtual Size: 173.3 MB
    └─a4cde3c49180 Virtual Size: 173.3 MB
      └─4bee8675c15c Virtual Size: 173.3 MB
        └─7f3c278241b0 Virtual Size: 173.3 MB
          └─ce4b4f32a844 Virtual Size: 173.3 MB
            └─b0cabb4b0199 Virtual Size: 245.1 MB
              └─4289ab84cde5 Virtual Size: 245.1 MB
                ├─30457c02f975 Virtual Size: 245.1 MB
                │ └─926008e362d2 Virtual Size: 245.5 MB
                │   └─89d2e184abbb Virtual Size: 245.5 MB
                │     └─5a84fb23c4bb Virtual Size: 245.5 MB
                │       └─f123e7561547 Virtual Size: 245.5 MB Tags: gwidx/chronicle-pro-sink:1.0.2-smaller-docker
                └─6e777817bede Virtual Size: 245.1 MB
                  └─b0d6daef2c59 Virtual Size: 245.5 MB
                    └─305224fe6626 Virtual Size: 245.5 MB
                      └─1e497c691243 Virtual Size: 245.5 MB
                        └─7620f8dc9344 Virtual Size: 245.5 MB Tags: gwidx/chronicle-pro-sink:1.0.3-smaller-docker
```


Such image is much better for Docker layer sharing and incremental push because whole difference is just 400kB. Common JAR dependencies, which don't usually change between versions are all stored in base shareable layer.

## Usage

This plugin cross-compiles for 0.13.17 and sbt 1.1.5.

Configure `sbt-native-packager >= 1.3.3` so you are able to publish docker images. 

Add plugin to `project/plugins.sbt`:

```scala
resolvers += Resolver.url("lustefaniak/sbt-plugins", url("https://dl.bintray.com/lustefaniak/sbt-plugins/"))(Resolver.ivyStylePatterns)

addSbtPlugin("net.globalwebindex" % "sbt-smaller-docker" % "0.0.2")
```

Enable and configure plugin:

```scala
def isFrequentlyChangingFile(file: sbt.File): Boolean = {
  val fileName = file.name
  fileName.startsWith("com.example")  || !fileName.endsWith(".jar")
}

enablePlugins(SmallerDockerPlugin)

smallerDockerSettings(isFrequentlyChangingFile)
```
